<!--
 * @Author: your name
 * @Date: 2022-03-09 15:35:25
 * @LastEditTime: 2022-03-10 10:39:28
 * @LastEditors: Please set LastEditors
 * @Description: 打开koroFileHeader查看配置 进行设置: https://github.com/OBKoro1/koro1FileHeader/wiki/%E9%85%8D%E7%BD%AE
 * @FilePath: /flv/dist/index.html
-->
<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Document</title>
  <script src="./wasm_exec.js"></script>
</head>

<body>

</body>
<script>
  // polyfill
  if (!WebAssembly.instantiateStreaming) {
    WebAssembly.instantiateStreaming = async (resp, importObject) => {
      const source = await (await resp).arrayBuffer()
      return await WebAssembly.instantiate(source, importObject)
    }
  }

  function loadWasm(path) {
    const go = new Go()
    return new Promise((resolve, reject) => {
      WebAssembly.instantiateStreaming(fetch(path), go.importObject)
        .then(result => {
          go.run(result.instance)
          resolve(result.instance)
        })
        .catch(error => {
          reject(error)
        })
    })
  }

  loadWasm('./main.wasm').then((wasm) => {
    console.log("main.wasm is loaded 👋")
    parserFlv()
    // requestFlv().then((res) => {
    //   res.arrayBuffer().then((buffer) => {
    //     var load = loadFlvDemuxer(0, new Uint8Array(buffer));
    //     console.log(load)
    //     setInterval(() => {
    //       console.log(read(0))
    //     }, 300)
    //   })
    // })
  })

  function requestFlv() {
    return fetch('./test.flv').then((response) => {
      return response.blob();
    })
  }

  let load_result;

  function parserFlv() {
    requestFlv().then((res) => {
      res.arrayBuffer().then((buffer) => {
        let data = new Uint8Array(buffer);
        const flv_header = data.subarray(0, 9);
        console.log('flv_header', flv_header)

        load_result = loadFlvDemuxer(0, data.subarray(0, 13));
        console.log('load_result', load_result)
        data = data.subarray(13);

        while (data.length) {
          const tag_head = data.subarray(0, 11);
          // console.log('tag_head_type', tag_head[0]);
          const size = tag_head[1] << 16 | tag_head[2] << 8 | tag_head[3];
          const tag = data.subarray(0, 11 + size);
          handleTag(tag);
          data = data.subarray(11 + size);

          let previous_tag_size = data.subarray(0, 4);
          data = data.subarray(4);
        }

        console.log('result_flv_length', data.length);
      });
    });
  }

  function handleTag(tag) {
    // console.log('tag',tag)
    if (load_result) {
      console.log(readTag(0, tag))
    }
  }

  function sliceBuffer(data, num) {
    num = num ? num : 1;
    const result = data.subarray(0, num);
    data = data.subarray(num);
    return result;
  }

</script>

</html>